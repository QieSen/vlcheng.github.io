{"posts":[{"title":"DietPi使用apt search搜索缓慢","content":"背景 最近给NanoPi Neo3安装了基于Debian优化的发行版DietPi v7.7.3，使用apt search时遇到了性能问题。 问题复现 sudo apt update正常刷新缓存，使用apt search some-package时进度卡在 Full Text Search过程，迅速达到50%然后变得异常慢，从top中可以看到apt正榨干cpu核心的所有时间，整个搜索过程将持续超过十分钟，尝试换用apt-cache search some-package但并不能规避，同样的问题在Armbian论坛[1]上也讨论。 $ apt --version apt 2.2.4 (arm64) $ sudo apt update Hit:1 …… Get:2 …… Reading package lists... Done Building dependency tree... Done Reading state information... Done All packages are up to date. $ apt search nano Sorting... Done Full Text Search... 50% ^C $ apt-cache search nano Sorting... Done Full Text Search... 52% 更换镜像源，使用sudo apt clean和sudo apt update再次刷新缓存，但问题依然存在。 原因和解决方法 在查找类似问题的过程中看到一篇中文博客[2]介绍了解决方法： $ sudo echo 'Acquire::GzipIndexes &quot;false&quot;;' | sudo tee /etc/apt/apt.conf.d/99disable-compression $ sudo rm /var/lib/apt/lists/*.gz # 如果你的压缩方式是 lz4，请对应更改 $ sudo apt update 通过高优先级配置禁用了apt对软件包列表进行压缩，粗暴但简单。如果只为解决搜索慢的问题，至此已经完成了。如果对于apt软件包列表的空间占用有顾虑，则可以使用lz4压缩方式。 空间与效率的权衡 查看DietPi的项目代码发现在/etc/apt/apt.conf.d/97dietpi中有默认启用xz压缩的配置，同时维护者指出[3]lzma算法会显著降低软件包列表的读取速度，而Armbian则使用gzip。实际上在apt手册[4]中有提到从1.6版本就已经开始支持压缩，Debian从buster开始默认启用这项特性。 比较多种压缩格式的效果 在/etc/apt/apt.conf.d/目录中创建99-index-compress文件，写入四行内容覆盖97dietpi的配置： Acquire::GzipIndexes &quot;true&quot;; Acquire::IndexTargets::deb::Packages::KeepCompressedAs &quot;xz&quot;; # gz、xz、lz4 Acquire::IndexTargets::deb::Translations::KeepCompressedAs &quot;xz&quot;; Acquire::IndexTargets::deb-src::Sources::KeepCompressedAs &quot;xz&quot;; 然后删除apt下载的所有文件，重新运行sudo apt update，再使用du -hd 0 /var/lib/apt/lists对目录大小进行统计： 格式 gz xz lz4 uncompress 体积 12M 8.6M 18M 47M 压缩比xz最好，lz4最差，但是体积并不是唯一的考量因素，为了稍微严谨一点，需要对三种压缩方式进行测试。为此找来一个目录，通过tar打包后体积为146MB，移动到/tmp避免外置存储带宽瓶颈，分别使用gzip、xz、lz4进行单线程压缩，使用默认设置。 软件 默认压缩等级 压缩 体积 压缩比 解压 tar/stable 1.34+dfsg-1 arm64 \\ \\ 146M \\ \\ gzip/stable 1.10-4 arm64 6 (1-9) 22s 40M 27.39% 4s lz4/stable 1.9.3-2 arm64 1 (1-9) 3s 66M 45.20% 2s xz-utils/stable 5.2.5-2 arm64 6 (0-9) 411s 32M 21.91% 9s xz -0 0 手动指定 52s 40M 27.39% 9s CPU: RK3328 quad-core@1.2GHz；RAM: 2GB 32bit DDR4@1066MHz；RootFS: 32GB SDCard. xz压缩默认压缩比设置为-6 (0-9)，额外测试了-0下的性能。测试结果确实反映了xz压缩的性能问题，尽管lzma算法压缩比一如既往的惊人，但高昂的时间成本丧尽了所有优势，并且在Google中未能找到有关lzma算法和ARM平台兼容性的反馈。 综合时间成本和响应速度考虑，apt软件包列表的空间占用不算太高，显然使用lz4压缩更加适合。 参考来源 Armbian: My apt search has become super slow recently 绒布地球: 解决在 Armbian 中执行 apt search 非常慢的问题 Github: MichaIng/DietPi Debian manpages: APT-TRANSPORT-MIRR(1) 最后更新于：2021年10月30日 13:16:06 ","link":"https://vlcheng.github.io/post/-ggrvzaf-/"}]}